#!/usr/bin/env bash
set -e

RED=$(tput setaf 1)
RESET=$(tput sgr0)

function echo_error() {
  echo "${RED}Error: $1${RESET}"
}

# Can't publish the default branch, of course
default_branch=$(git-default-branch)
current_branch=$(git branch-name)
if [ "$current_branch" = "$default_branch" ]; then
  echo_error "Cannot publish the default branch '$default_branch'"
  exit 1
fi

# Warn if there is more than one commit,
# or if that commit has WIP in the message
commit_count=$(git rev-list --count "$default_branch"..HEAD)
latest_commit_message=$(git log -1 --pretty=%B)
if [ "$commit_count" -gt 1 ] || [[ "$latest_commit_message" == *"WIP"* ]]; then
  echo_error "This doesn't look ready to publish."
  echo
  git log --oneline "$default_branch"..
  exit 1
fi

# Push the branch if necessary
if ! git ls-remote --exit-code origin "$current_branch" &>/dev/null; then
  git publish
fi
gh pr create --fill-first "$@"
